<% provide(:title, "Scan") %>

<div class="container">
    <!--<div class="row"><button class="main_button" id="scan_barcode" onClick="toggleDiv()">Scan Barcode</button></div>-->
    <!--<div class="row" id="hidden_row" style="display:none;">-->
    <!--    <button class="secondary_button">Inventory</button>-->
    <!--    <button class="secondary_button">Checkout</button>-->
    <!--</div>-->
    <!--<div class="row"><button class="main_button">View Database</button></div>-->
    <script>
        var Quagga = window.Quagga;
        var App = {
            _scanner: null,
            init: function() {
                this.attachListeners();
            },
            decode: function(src) {
                Quagga
                    .decoder({readers: ['ean_reader']})
                    .locator({patchSize: 'medium'})
                    .fromImage(src, {size: 800})
                    .toPromise()
                    .then(function(result) {
                        document.querySelector('input.isbn').value = result.codeResult.code;
                    })
                    .catch(function() {
                        document.querySelector('input.isbn').value = "Not Found";
                    })
                    .then(function() {
                        this.attachListeners();
                    }.bind(this));
            },
            attachListeners: function() {
                var self = this,
                    button = document.querySelector('.input-field input + .button.scan'),
                    fileInput = document.querySelector('.input-field input[type=file]');
        
                button.addEventListener("click", function onClick(e) {
                    e.preventDefault();
                    button.removeEventListener("click", onClick);
                    document.querySelector('.input-field input[type=file]').click();
                });
        
                fileInput.addEventListener("change", function onChange(e) {
                    e.preventDefault();
                    fileInput.removeEventListener("change", onChange);
                    if (e.target.files && e.target.files.length) {
                        self.decode(URL.createObjectURL(e.target.files[0]));
                    }
                });
            }
        };
        App.init();
    </script>
    
    <form>
        <div class="input-field">
            <label for="isbn_input">EAN:</label>
            <input id="isbn_input" class="isbn" type="file" accept="image/*" capture="camera" />
            <button type="button" class="icon-barcode button scan">&nbsp;</button>
        </div>
    </form>
</div>